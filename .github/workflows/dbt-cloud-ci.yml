name: dbt Cloud CI/CD (trigger, poll, comment)

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  trigger_and_monitor_dbt_cloud:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Set up jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Trigger dbt Cloud run
        id: trigger
        env:
          DBT_CLOUD_API_KEY: ${{ secrets.DBT_CLOUD_API_KEY }}
          DBT_CLOUD_ACCOUNT_ID: ${{ secrets.DBT_CLOUD_ACCOUNT_ID }}
          DBT_CLOUD_JOB_ID: ${{ secrets.DBT_CLOUD_JOB_ID }}
        run: |
          set -euo pipefail
          COMMIT_SHA=${{ github.sha }}
          echo "Triggering dbt Cloud job ${DBT_CLOUD_JOB_ID} for commit ${COMMIT_SHA}"

          RESP=$(curl -s -X POST \
            "https://cloud.getdbt.com/api/v2/accounts/${DBT_CLOUD_ACCOUNT_ID}/jobs/${DBT_CLOUD_JOB_ID}/run/" \
            -H "Authorization: Bearer ${DBT_CLOUD_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"cause":"Push to main","git_sha":"'"${COMMIT_SHA}"'"}')
